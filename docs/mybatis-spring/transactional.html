<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Feb 11, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="The MyBatis Team" />
    <meta name="Date-Revision-yyyymmdd" content="20130211" />
    <meta http-equiv="Content-Language" content="en" />
    <title>MyBatis - 
    MyBatis Guice | @Transactional</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="../" id="bannerLeft" title="MyBatis logo">
                                                                                                <img src="../images/logo.png"  alt="MyBatis logo"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 11 February 2013</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 3.4-SNAPSHOT</li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Reference Documentation</li>
                                
      <li>
    
                          <a href="index.html" title="Introduction">
          <i class="none"></i>
        Introduction</a>
            </li>
                  
      <li>
    
                          <a href="getting-started.html" title="Getting Started">
          <i class="none"></i>
        Getting Started</a>
            </li>
                  
      <li>
    
                          <a href="core.html" title="Core components">
          <i class="none"></i>
        Core components</a>
            </li>
                                                                                                                    
      <li>
    
                          <a href="datasources.html" title="Data Sources">
          <i class="icon-chevron-down"></i>
        Data Sources</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="datasources/builtin.html" title="MyBatis built-in">
          <i class="none"></i>
        MyBatis built-in</a>
            </li>
                      
      <li>
    
                          <a href="datasources/dbcp.html" title="Apache Commons DBCP">
          <i class="none"></i>
        Apache Commons DBCP</a>
            </li>
                      
      <li>
    
                          <a href="datasources/c3p0.html" title="C3P0">
          <i class="none"></i>
        C3P0</a>
            </li>
                      
      <li>
    
                          <a href="datasources/bonecp.html" title="BoneCP">
          <i class="none"></i>
        BoneCP</a>
            </li>
              </ul>
        </li>
                  
      <li>
    
                          <a href="injections.html" title="Injections">
          <i class="none"></i>
        Injections</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>@Transactional</a>
          </li>
                  
      <li>
    
                          <a href="jdbc-helper.html" title="JDBC Helper">
          <i class="none"></i>
        JDBC Helper</a>
            </li>
                  
      <li>
    
                          <a href="samples.html" title="Samples">
          <i class="none"></i>
        Samples</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                          
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                                                        
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <!-- Copyright 2010-2012 The MyBatis Team

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. --><!-- version: $Id$ -->

  
    <div class="section"><h2>@Transactional<a name="aTransactional"></a></h2>

    <div class="section"><h3>Introduction<a name="Introduction"></a></h3>
        <p>
            Thanks to the excellent combination between <tt>AOP</tt>
            and Google Guice, users can drastically reduce the boilerplate
            code into their DAOs.
        </p>
        <p>
            Let's take in consideration the following code snippet, written
            without introducing mybatis-guice:
                </p><div class="source"><pre class="prettyprint">package com.acme;

import org.apache.ibatis.session.*;
import org.mybatis.guice.transactional.*;

public final class FooDAO {

    private final SqlSessionManager sessionManager;

    public FooDAO(SqlSessionManager sessionManager) {
        this.sessionManager = sessionManager;
    }

    public void doFooBar() throws MyDaoException {
        // Starts a new SqlSession
        this.sessionManager.startManagedSession(ExecutorType.BATCH,
            TransactionIsolationLevel.READ_UNCOMMITTED);
        try {
            // Retrieve the FooMapper and execute the doFoo() method.
            FooMapper fooMapper = this.sessionManager.getMapper(FooMapper.class);
            fooMapper.doFoo();

            // Retrieve the BarMapper and execute the doBar() method.
            BarMapper barMapper = this.sessionManager.getMapper(BarMapper.class);
            barMapper.doBar();

            // If everything gone fine, commit the open session.
            this.sessionManager.commit();
        } catch (Throwable t) {
            // If something gone wrong, rollback the open session.
            this.sessionManager.rollback();
            // Optionally, throw a proper DAO layer Exception
            throw new MyDaoException(&quot;Something went wrong&quot;, t);
        } finally {
            // Close the session.
            this.sessionManager.close();
        }
    }

}</pre></div>
        
        <p>
            Users can easily note that this is a recursive and redundant code
            pattern that mybatis-guice will help to simplify introducing a
            special <tt>AOP</tt> interceptor.
        </p>
    </div>

    <div class="section"><h3>The @Transactional annotation<a name="The_Transactional_annotation"></a></h3>
        <p>
            Annotating methods with the <tt>org.mybatis.guice.transactional.Transactional</tt>
            annotation, users can eliminate recursive code patterns.
        </p>
        <p>
            First of all, let's have a look at the injector that will create the
            previous <tt>FooDAO</tt> instance:
            </p><div class="source"><pre class="prettyprint">Class&lt;? extends Provider&lt;DataSource&gt;&gt; dataSourceProviderClass = [...];
Class&lt;? extends Provider&lt;TransactionFactory&gt;&gt; txFactoryProviderClass = [...];

Injector injector = Guice.createInjector(new MyBatisModule() {

        @Override
        protected void initialize() {
            environmentId(&quot;test&quot;);
            bindDataSourceProviderType(dataSourceProviderType);
            bindTransactionFactoryType(txFactoryClass);
            addMapperClass(FooMapper.class);
            addMapperClass(BarMapper.class);
        }

    }
);

FooDAO fooDAO = injector.getInstance(FooDAO.class);</pre></div>
        
        <p>
            Where <tt>FooDAO</tt> definition is:
            </p><div class="source"><pre class="prettyprint">package com.acme;

import javax.inject.*;
import org.apache.ibatis.session.*;
import org.mybatis.guice.transactional.*;

@Singleton
public final class FooDAOImpl {

    @Inject
    private FooMapper fooMapper;

    @Inject
    private BarMapper barMapper;

    // let's assume setters here

    @Transactional(
        executorType = ExecutorType.BATCH,
        isolation = Isolation.READ_UNCOMMITTED,
        rethrowExceptionsAs = MyDaoException.class,
        exceptionMessage = &quot;Something went wrong&quot;
    )
    public void doFooBar() {
        this.fooMapper.doFoo();
        this.barMapper.doBar();
    }

}</pre></div>
        
        <p>
            Users can now simply read how the code can be reduced, delegating
            to the interceptor the session management!
        </p>
        <p>
            The <tt>org.mybatis.guice.transactional.Transactional</tt>
            annotation supports the following parameters:</p>
            <table border="0" class="table table-striped"><caption>org.mybatis.guice.transactional.Transactional properties</caption>
                
                <thead>
                    <tr class="a">
                        <th>Property</th>
                        <th>Default</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="b">
                        <td>executorType</td>
                        <td>ExecutorType.SIMPLE</td>
                        <td>the MyBatis executor type</td>
                    </tr>
                    <tr class="a">
                        <td>isolation</td>
                        <td>Isolation.DEFAULT</td>
                        <td>the transaction isolation level.  The default value will
                          cause MyBatis to use the default isolation level from the
                          data source.</td>
                    </tr>
                    <tr class="b">
                        <td>force</td>
                        <td>false</td>
                        <td>Flag to indicate that MyBatis has to force the
                        transaction <tt>commit()</tt></td>
                    </tr>
                    <tr class="a">
                        <td>rethrowExceptionsAs</td>
                        <td>Exception.class</td>
                        <td>rethrow caught exceptions as new Exception
                        (maybe a proper layer exception)</td>
                    </tr>
                    <tr class="b">
                        <td>exceptionMessage</td>
                        <td>empty string</td>
                        <td>A custom error message when throwing the custom exception;
                        it supports <tt>java.util.Formatter</tt>
                        place holders, intercepted method arguments will be used
                        as message format arguments.</td>
                    </tr>
                    <tr class="a">
                        <td>rollbackOnly</td>
                        <td>false</td>
                        <td>If true, the transaction will never committed, but rather the rollback will be forced.
                        That configuration is useful for testing purposes.</td>
                    </tr>
                </tbody>
            </table>
        <p>
            When specifying <tt>rethrowExceptionsAs</tt> parameter,
            it is required that the target exception type has the constructor
            with <tt>Throwable</tt> single argument; when specifying
            both <tt>rethrowExceptionsAs</tt> and <tt>exceptionMessage</tt>
            parameters, it is required that the target exception type has the constructor
            with <tt>String, Throwable</tt> arguments;
            specifying the <tt>exceptionMessage</tt> parameter only
            doesn't have any effect.
        </p>
    </div>

    <div class="section"><h3>Nested transactions<a name="Nested_transactions"></a></h3>
        <p>
            The <tt>org.mybatis.guice.transactional.Transactional</tt>
            annotation is nicely handled to support inner transactional methods;
            given the following simple MyBatis clients:
            </p><div class="source"><pre class="prettyprint">class ServiceA {

    @Transactional
    public void method() {
        ...
    }

}

class ServiceB {

    @Transactional
    public void method() {
        ...
    }

}</pre></div>
        
        <p>
            That in a certain point are involved in another one in the same
            transaction:
            </p><div class="source"><pre class="prettyprint">class CompositeService {

    @Inject
    ServiceA serviceA;

    @Inject
    ServiceB serviceB;

    @Transactional
    public void method() {
        ...
        this.serviceA.method();
        ...
        this.serviceB.method();
        ...
    }

}</pre></div>
        
        <p>
            In this case, <tt>ServiceA#method()</tt> and
            <tt>ServiceB#method</tt> can be invoked as atomic transactions,
            the advantage is when <tt>serviceA#method()</tt> and
            <tt>serviceB#method()</tt> will be invoked inside the 
            <tt>CompositeService#method</tt>, that the interceptor will
            take care to manage them in the same session, even if annotated to
            start a new transaction.
        </p>
    </div>

</div>




                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2010-2013
                        <a href="http://www.mybatis.org/">MyBatis.org</a>.
            All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
